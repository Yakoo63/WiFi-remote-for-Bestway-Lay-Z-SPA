<!DOCTYPE html>
<html lang="en">
<head>
  <title data-i18n="titre_networkconfig">Network Config</title>
  <meta charset="utf-8">
  <link rel="icon" type="image/png" sizes="180x180" href="favicon.png">
  <meta name="theme-color" content="#0f4677">
  <link rel="stylesheet" href="main.css">
  <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1">
</head>

<body>

  <div id="site">
    <!-- ==================== HEADER ==================== -->
    <header>
      <form id="darkModeForm">
        <label class="switch">
          <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
          <span class="slider round"></span>
        </label>
      </form>
      <a href="./">
        <div id="header">
          <span data-i18n="header_networkconfig">Network Config</span>
          <span data-i18n="header_module">Lay-Z-Spa Module</span>
        </div>
      </a>
      <a href="javascript:void(0);" class="topnavicon" onclick="topNav()"></a>


    </header>

    <!-- ==================== MENU BURGER ==================== -->
    <div class="topnav" id="topnav">
      <a href="./" data-i18n="menu_home">Home</a>
      <a href="hwconfig.html" data-i18n="menu_hwconfig">Hardware Config</a>
      <a href="config.html" data-i18n="menu_spaconfig">SPA Config</a>
      <a href="webconfig.html" data-i18n="menu_webconfig">Web Config</a>
      <a href="wifi.html" class="active" data-i18n="menu_networkconfig">Network Config</a>
      <a href="mqtt.html" data-i18n="menu_mqttconfig">MQTT Config</a>
      <a href="/dir/" data-i18n="menu_directory">Directory</a>
      <a href="upload.html" data-i18n="menu_upload">File Uploader</a>
      <a href="remove.html" data-i18n="menu_remove">File Remover</a>
      <a href="chkupdatefw.html" data-i18n="menu_chkupdatefw">Check firmware update</a>
      <a href="/restart/" data-i18n="menu_restart">Restart ESP</a>
    </div>


    <!-- ==================== SECTION: Access Point ==================== -->
    <section>
      <h2 data-i18n="section_ap">Access Point:</h2>
      <table>
        <tr>
          <td>
            <label for="enableAp" data-i18n="label_enableAp">Enable specific AP:</label>
            <span
              class="tooltip"
              data-text="Checked: ESP will connect using these credentials. Unchecked: ESP will use last known credentials."
              data-i18n="[data-text]tooltip_enableAp"
            >?</span>
          </td>
          <td>
            <input type="checkbox" id="enableAp">
          </td>
        </tr>
        <tr>
          <td>
            <label for="apSsid" data-i18n="label_ssid">SSID:</label>
          </td>
          <td>
            <input type="text" id="apSsid">
          </td>
        </tr>
        <tr>
          <td>
            <label for="apPwd" data-i18n="label_password">Password:</label>
          </td>
          <td>
            <input type="text" id="apPwd">
          </td>
        </tr>
      </table>
    </section>


    <!-- ==================== SECTION: Soft Access Point ==================== -->
    <section>
      <h2 data-i18n="section_softap">Soft Access Point:</h2>
      <table>
        <tr>
          <td>
            <label for="enableWM" data-i18n="label_enableWM">
              Enable Soft AP (I don’t see a reason to uncheck this! You can lock yourself out!):
            </label>
            <span
              class="tooltip"
              data-text="Enable ESP access point to be able to open this page before your network credentials are set. You’d want this on normally! If your network is unavailable, the ESP will fire up its own AP."
              data-i18n="[data-text]tooltip_enableWM"
            >?</span>
          </td>
          <td>
            <input type="checkbox" id="enableWM">
          </td>
        </tr>
      </table>
    </section>


    <!-- ==================== SECTION: Static IP ==================== -->
    <section>
      <h2 data-i18n="section_static_ip">Static IP:</h2>
      <table>
        <tr>
          <td>
            <label for="enableStaticIp4" data-i18n="label_enable_static_ip">Enable static IP:</label>
          </td>
          <td>
            <input type="checkbox" id="enableStaticIp4">
          </td>
        </tr>
        <tr>
          <td>
            <label for="ip4Address" data-i18n="label_ip_address">IP Address:</label>
            <span
              class="tooltip"
              data-text="Leave blank for DHCP or type a correct IP."
              data-i18n="[data-text]tooltip_ipStatic"
            >?</span>
          </td>
          <td>
            <input type="text" id="ip4Address" maxlength="15" style="width:185px">
          </td>
        </tr>
        <tr>
          <td>
            <label for="ip4Gateway" data-i18n="label_gateway_ip">Gateway IP Address:</label>
            <span
              class="tooltip"
              data-text="Usually your router. Leave blank for default."
              data-i18n="[data-text]tooltip_gateway"
            >?</span>
          </td>
          <td>
            <input type="text" id="ip4Gateway" maxlength="15" style="width:185px">
          </td>
        </tr>
        <tr>
          <td>
            <label for="ip4Subnet" data-i18n="label_subnet_mask">Subnet Mask:</label>
            <span
              class="tooltip"
              data-text="Most of the time this is 255.255.255.0. Leave blank for default."
              data-i18n="[data-text]tooltip_netmask"
            >?</span>
          </td>
          <td>
            <input type="text" id="ip4Subnet" maxlength="15" style="width:185px">
          </td>
        </tr>
        <tr>
          <td>
            <label for="ip4DnsPrimary" data-i18n="label_dns_primary">DNS Server (primary):</label>
            <span
              class="tooltip"
              data-text="Use your router or ISP DNS. Leave blank for default."
              data-i18n="[data-text]tooltip_dnsPrimary"
            >?</span>
          </td>
          <td>
            <input type="text" id="ip4DnsPrimary" maxlength="15" style="width:185px">
          </td>
        </tr>
        <tr>
          <td>
            <label for="ip4DnsSecondary" data-i18n="label_dns_secondary">DNS Server (secondary):</label>
            <span
              class="tooltip"
              data-text="Alternate DNS. Leave blank for none."
              data-i18n="[data-text]tooltip_dnsSecondary"
            >?</span>
          </td>
          <td>
            <input type="text" id="ip4DnsSecondary" maxlength="15" style="width:185px">
          </td>
        </tr>
      </table>
    </section>


    <!-- ==================== SECTION: NTP Server ==================== -->
    <section>
      <h2 data-i18n="section_ntp">NTP server:</h2>
      <table>
        <tr>
          <td>
            <label for="ip4NTP" data-i18n="label_ntp_address">Domain name or IP address:</label>
            <span
              class="tooltip"
              data-text="Leave blank for pool.ntp.org (default)."
              data-i18n="[data-text]tooltip_ntpServer"
            >?</span>
          </td>
          <td>
            <input type="text" id="ip4NTP" maxlength="30" style="width:185px" value="pool.ntp.org">
          </td>
        </tr>
      </table>
    </section>


    <!-- ==================== BUTTON “SAVE” ==================== -->
    <section>
      <table>
        <tr>
          <td colspan="2" style="text-align:center">
            <button id="save" class="button" onclick="saveNetworkConfig()" data-i18n="bouton_save">Enregistrer</button>
          </td>
        </tr>
      </table>
    </section>


    <!-- ==================== SECTION: Reset WiFi Config ==================== -->
    <section>
      <h2 data-i18n="section_reset_wifi">Reset WiFi Config:</h2>
      <p data-i18n="reset_wifi_note">
        This button deletes the WiFi credentials.<br>
        The ESP will restart and enable its own AP (if you have it checked above).<br>
        Connect to WiFi AP with SSID "layzspa_module######" and go to address http://192.168.4.2/wifi.html
      </p>
    </section>


    <!-- ==================== FOOTER: Reset WiFi Button ==================== -->
    <footer class="center">
      <button id="resetwifi" class="button_red" onclick="resetWifi()" data-i18n="btn_reset_wifi">réinitialiser WiFi</button>
    </footer>
  </div>


  <!-- ==================== SCRIPTS ==================== -->
  <script>

    function topNav() {
      var x = document.getElementById("topnav");
      if (x.className === "topnav") {
        x.className += " responsive";
      } else {
        x.className = "topnav";
      }
    }

    function togglePlainText(id) {
      var x = document.getElementById(id);
      if (x.type === "password") {
        x.type = "text";
      } else {
        x.type = "password";
      }
    }

    function validatePassword(id) {
      var x = document.getElementById(id);
      if (x.value == "<enter password>") {
        alert("Please enter a password to continue.");
        return false;
      }
      return true;
    }

    function buttonConfirm(elem, text = "", timeout = 3, reset = true) {
      var originalText = elem.innerHTML;
      elem.innerHTML = text == "" ? "&check;" : text;
      elem.disabled = true;
      if (reset) {
        setTimeout(function () {
          elem.innerHTML = originalText;
          elem.disabled = false;
        }, timeout * 1000);
      }
    }

    function loadNetworkConfig() {
      var req = new XMLHttpRequest();
      req.open('POST', '/getwifi/');
      req.send();
      req.onreadystatechange = function() {
        if (this.readyState === 4 && this.status === 200) {
          var json = JSON.parse(req.responseText);

          document.getElementById('enableAp').checked        = !!json.enableAp;
          document.getElementById('apSsid').value            = json.apSsid    || '';
          document.getElementById('apPwd').value             = json.apPwd     || '';
          document.getElementById('enableWM').checked        = !!json.enableWM;

          document.getElementById('enableStaticIp4').checked = !!json.enableStaticIp4;
          document.getElementById('ip4Address').value         = json.ip4Address        || '';
          document.getElementById('ip4Gateway').value         = json.ip4Gateway        || '';
          document.getElementById('ip4Subnet').value          = json.ip4Subnet         || '';
          document.getElementById('ip4DnsPrimary').value      = json.ip4DnsPrimary     || '';
          document.getElementById('ip4DnsSecondary').value    = json.ip4DnsSecondary   || '';
          document.getElementById('ip4NTP').value             = json.ip4NTP            || '';
        }
      }
    }

    function saveNetworkConfig() {
      if (!validatePassword('apPwd')) return;

      buttonConfirm(
        document.getElementById('save'),
        "saved &check; (Don't forget to restart the ESP.)",
        6
      );

      var req = new XMLHttpRequest();
      req.open('POST', '/setwifi/');
      var json = {
        enableAp:         document.getElementById('enableAp').checked,
        apSsid:           document.getElementById('apSsid').value,
        apPwd:            document.getElementById('apPwd').value,
        enableWM:         document.getElementById('enableWM').checked,
        enableStaticIp4:  document.getElementById('enableStaticIp4').checked,
        ip4Address:       document.getElementById('ip4Address').value,
        ip4Gateway:       document.getElementById('ip4Gateway').value,
        ip4Subnet:        document.getElementById('ip4Subnet').value,
        ip4DnsPrimary:    document.getElementById('ip4DnsPrimary').value,
        ip4DnsSecondary:  document.getElementById('ip4DnsSecondary').value,
        ip4NTP:           document.getElementById('ip4NTP').value
      };
      req.send(JSON.stringify(json));
      document.getElementById('apPwd').value = '<enter password>';
    }

    function resetWifi() {
      if (confirm('Do you really want to reset the WiFi?')) {
        var req = new XMLHttpRequest();
        req.open('POST', '/resetwifi/');
        req.send();
        document.body.innerHTML =
          'ESP restarts now. Please connect to the access point and re-configure your WiFi.';
      }
    }

    document.addEventListener('DOMContentLoaded', function () {
      loadNetworkConfig();

      // Gestion du changement de langue (i18n)
      const selectLang = document.getElementById('lang-select');
      function switchLang(langCode) {
        if (langCode === 'en-EN') {
          localStorage.setItem('langueSPA', langCode);
          location.reload();
        } else {
          localStorage.setItem('langueSPA', langCode);
          selectLang.value = langCode;
          selectLang.dispatchEvent(new Event('change'));
        }
      }
      document.querySelectorAll('#lang-flags .flag').forEach(span => {
        span.addEventListener('click', () => {
          switchLang(span.getAttribute('data-lang'));
        });
      });
    });
  </script>

  <!-- i18n.js inchangé -->
  <script src="i18n.js"></script>
  <script src="darkmode.js" type="text/javascript"></script>
</body>
</html>
